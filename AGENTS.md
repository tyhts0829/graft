# Repository Guidelines (AGENTS.md)

本ファイルは、エージェント/人間が共通で参照する「短く・具体的・反復可」な運用規約。近接する AGENTS.md が優先される（ネスト時）。以下のチェックは“実施すべき”前提。

## 一般的な指示

- 必要十分な堅牢さ。複雑化を避け、可読性・シンプルさ・美しさを優先。過度に防御的な実装は絶対にしないこと。
- 賢さ、高度さよりも明確さを好みます。複雑さよりもシンプルを好みます。
- このリポジトリはまだ配布しておらず、ユーザーは居ないので、破壊的変更でも構わないので美しいシンプルな実装を目指すこと。実装改善に伴い互換ラッパー、シムなどは実装しないこと。
- '報告して'や'どう思う？'や'提案して'といった指示は、聞かれたことだけ答え、コードを先回りして変更しないこと。
- 作業開始時に必ず `git status --porcelain` を確認し、依頼範囲外の差分がある場合は**ユーザー確認なしに**「上書き/巻き戻し/ステージ操作」をしないこと。
- ルート AGENTS.md の最小項目（Build/Test/Style/Safety/PR）を常に最新化
- コード改善を指示された場合、コード変更前に、改善アクションを細分化したチェックリストを新規.md ファイルとして保存し、私にそれでいいか確認してください。その後、私の返答に基づいて改善を行い、完了アイテムをチェックしていき、何が完了し、何が完了していないかを常に明確にして下さい。改善の中で気がついた、私に事前確認したほうがいいことや、さらなる改善提案があれば、その md ファイルに追記して報告してください。
- 回答は日本語。

## Build

- src レイアウト: 本体パッケージは `src/grafix/`（import 名は `grafix`）
- 推奨（描画/GUI まで）: `pip install -e .`
- dev ツール: `pip install -e ".[dev]"`

## Test

- インストール無し: `PYTHONPATH=src pytest -q`
- インストール後: `pytest -q`

## Style

- ruff: `ruff check .`
- mypy: `mypy src/grafix`

## Safety & Permissions（許可境界）

- Allow（事前承認不要）:
  - 読取/一覧（`rg`, `cat` 等）
  - Lint/Format/Type/Test の“単一/対象限定”実行（上記ファイル単位コマンド）
  - スタブ生成のドライラン/差分確認
- Ask-first（要承認）:
  - 依存追加/更新（`pip install`, `uv sync` 等のネットワーク）
  - 破壊的操作（`rm`、権限変更、大量移動/rename）
  - 依頼範囲外の差分を「元に戻す/整理する/ステージする/アンステージする」操作（`git restore/reset/add` や、`apply_patch` による巻き戻しを含む）
  - 未追跡ファイル（`git status` の `??`）や依頼範囲外ファイルの削除・移動・上書き（`apply_patch` の Delete/Move を含む）
  - フルビルド/全体テストの長時間実行、CI 設定変更
  - スナップショット更新やベースライン生成などリポ内容を書き換える操作
  - `git push` / リリース作業

## PR

- 変更は依頼範囲に限定し、不要な互換ラッパー/シムは作らない
- 破壊的操作や依存追加は Safety の Ask-first に従う
- `git commit` / `git push` は依頼がある場合のみ

## ドキュメンテーション

- 原則『What/How はコードと型, Why/Trade-off はコメント』
- 各ファイルの先頭には簡潔なヘッダ(どこで・何を・なぜ)をつける。
- 明確で単純な説明を優先し、直感的でないロジックにはコメントを書く。
- すべての公開 API に NumPy スタイル docstring + 型ヒント。
  - docstring: 日本語の事実記述（主語省略・終止形、絵文字不可）。
  - 目的・設計意図・既知のトレードオフのみを短く記す。逐語説明や重複は避ける。
- 型ヒント: `dict[str, Any]` 等の組込みジェネリックで統一。`typing` 由来は最小限（`Callable`, `Mapping`, `Sequence`）。
- 影響大の判断は ADR（背景 → 決定 → 根拠 → 結果）。
- lint: ruff。型: mypy + pylance。

## テスト指針

- `pytest` 使用。`tests/test_*.py` を対象モジュールと対応させる。
- 乱数は固定し再現性を確保。
- 公開 API 変更時はスタブ再生成し、スタブ同期テストを更新。
- マーカー別の実行例:
  - 並行処理: `pytest -q -m integration -k worker`
  - スタブ同期: `pytest -q tests/stubs/test_g_stub_sync.py`
  - e2e/perf: `pytest -q -m "e2e or perf"`
