# fill の angle が 90° フリップするバグ: 実装改善計画

## 背景 / 現状

- 現象: `main.py` を実行し、`E.affine(rotation=(t*5, t*5, t*5)).fill()` のように回転をフレームごとに変えると、`fill` のハッチ角が「90°傾く / 戻る」を繰り返す。
- 原因（実装起因）: `src/effects/fill.py` の平面当てはめ `_fit_plane_basis` が SVD 由来の法線（`vh[-1]`）をそのまま使っており、特異ベクトルの符号が未規定なためフレーム間で `normal` が `n` / `-n` に反転し得る。結果として 2D 基底が鏡映し、`angle=45°` が `-45°` 相当に見えて 90°ジャンプになる。
- 旧実装（`src/effects/from_previous_project/done/fill.py`）では `transform_to_xy_plane / transform_back` 系の「回転行列＋zオフセット」で XY へ整列しており、少なくともこの現象は起きない。

## ゴール

- フレーム間で `fill` の 2D 基底が不連続に反転しない（= angle が勝手に 90°ジャンプしない）。
- `src/effects/from_previous_project/done/fill.py` と同様に、回転などの時間変化に対して見た目が安定する。

## 方針（推奨）

### 方針A: `src/effects/util.py` を使った XY 整列へ寄せる（推奨）

`src/effects/util.py` の `transform_to_xy_plane / transform_back` を利用し、3D→2D（XY）射影と 2D→3D 復元を統一する。

- メリット
  - SVD の符号曖昧性を根本から回避できる（法線はポリラインの頂点順に基づく）。
  - 2D射影/復元が「回転行列 R と z_offset」で明確になり、処理が読みやすくなりやすい。
  - `@njit(cache=True)` により、1フレーム内で多数の面を処理するケースで高速化の余地がある。
- デメリット / 注意点
  - `transform_to_xy_plane` の法線は「先頭3点の外積」なので、退化（3点が一直線）しているポリラインでは姿勢が決まらない。→対策は「基準リング選択」を少しだけ工夫する（過度に防御的にしない）。

### 方針B: 既存 SVD 経路を残しつつ “符号だけ” を固定する（最小修正）

`_fit_plane_basis` 内で、SVD 法線の向きを参照法線（例: 多角形の向きから得る法線）に合わせて反転する。

- メリット: 変更が局所的。
- デメリット: 参照法線の定義が必要で、結局 3D→2D の基底設計が複雑になりやすい。

## 実施タスク（チェックリスト）

### 0. 再現の固定化

- [ ] 既知の再現スケッチ（`main.py`）で現象が出ることを再確認する
- [x] 目視だけでなく、フレーム間の「角度フリップ」を検出できる最小スクリプト/テスト条件を決める

### 1. 旧実装の “安定性の源” を抽出

- [x] `src/effects/from_previous_project/done/fill.py` が採用している座標変換（XY整列→復元）の最小要件を整理する
- [ ] 現行 `src/effects/fill.py` と旧実装の「平面判定」「射影/復元」「角度の定義」を差分として言語化する

### 2. 実装方針の確定（A/Bの最終決定）

- [x] 方針A（util 利用）で置換する範囲を決める
  - [x] グローバル共平面パス（`planar_global` 相当）
  - [x] 非共平面フォールバックの各ポリラインパス
- [ ] 方針B（符号固定）を選ぶ場合の参照法線の取り方を決める

### 3. 実装（方針A: util 利用の場合）

- [x] `src/effects/fill.py` の 2D射影/復元を `transform_to_xy_plane / transform_back` に置換する
  - [x] 各ポリライン: `transform_to_xy_plane(vertices)` で XY 整列し、z残差で平面性判定
  - [x] グローバル: 基準リング（最初に姿勢が決まるリング）から `R_all, z_all` を得て全頂点に適用、z残差で共平面判定
  - [x] ハッチ生成は「XY の (x,y)」で行い、復元時は `z=0` を付けて `transform_back` する
- [x] `src/effects/AGENTS.md` の制約に合わせ、`src/effects/fill.py` の先頭コメント/ドキュメント形式が違反しないよう整理する（ファイルを触る以上、規約に従う）

### 4. 回帰テスト（必須）

- [x] `tests/test_fill.py` に回帰テストを追加し、連続回転で angle が 90°ジャンプしないことを検証する
  - [x] 入力: 単一の閉ポリライン（正方形）
  - [x] 手順: 回転角を少しずつ変えた複数ステップで `fill(remove_boundary=True)` を呼び、生成線分の方向ベクトルの変化が不連続（≈直交）にならないことをチェックする
  - [x] 期待: 連続ステップ間の `abs(dot(dir_i, dir_{i+1}))` が十分大きい（例: > 0.5）

### 5. 最小限の性能/挙動確認（任意）

- [ ] `fill` の実行時間を簡易比較し、util 利用で遅くならないことを確認する（初回 numba コンパイル除外）
- [ ] `angle_sets>1` / `spacing_gradient!=0` / `remove_boundary` の組み合わせで見た目が破綻しないことを確認する

## 事前確認したいこと（質問）

- 1) `fill.angle` の基準は「面ローカル座標（=面に貼り付く）」で安定していればよい、という理解で合っていますか？（現象の修正はこの前提で進めます）
- 2) 方針A（util 利用）へ寄せるのを “推奨” にしましたが、変更範囲が増えるのは許容ですか？（最小修正の方針Bも選べます）

## 追加で気づいたこと（別件）

- 回転を `t` 依存にすると GeometryId が毎フレーム変わり、`src/core/realize.py` の `realize_cache` が無制限に増えます（メモリ面の別課題）。今回のバグ修正とは切り離して扱うのが良いです。
- `src/effects/util.py` の `@njit` 実装が `np.dot` 経由で SciPy を要求しており、SciPy が入っていない環境でコンパイルエラーになりました。`np.dot` を使わない 3x3 専用の実装へ置換して、依存追加なしで利用できるようにしました。
